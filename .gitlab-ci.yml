
# For more information, see: https://docs.gitlab.com/ee/ci/yaml/index.html#stages

stages:          
  - runner_test
  - build
  - update_ECR

prologue-job:
  stage: runner_test
  script:
    - echo "Runner is starting . . ."

build-images:
  stage: build
  image: docker:latest
  services:
    - docker:23.0.1-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - docker --version
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY_IMAGE/app-frontend:latest ./frontend
    - docker build -t $CI_REGISTRY_IMAGE/app-backend:latest ./backend2
    - docker push $CI_REGISTRY_IMAGE/app-frontend:latest
    - docker push $CI_REGISTRY_IMAGE/app-backend:latest
  only:
    - main

aws-job:
  stage: update_ECR
  image: docker:latest
  services:
    - docker:23.0.1-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apk add --no-cache python3 py3-pip
    - python3 -m venv /venv
    - . /venv/bin/activate
    - pip install awscli
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - docker --version
    - aws --version

    - docker pull $CI_REGISTRY_IMAGE/app-frontend:latest
    - docker pull $CI_REGISTRY_IMAGE/app-backend:latest

    - docker tag $CI_REGISTRY_IMAGE/app-frontend:latest $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/dimgroz-ecr-dr/app-frontend:latest
    - docker tag $CI_REGISTRY_IMAGE/app-backend:latest $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/dimgroz-ecr-dr/app-backend:latest
    
    - docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/dimgroz-ecr-dr/app-frontend:latest
    - docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/dimgroz-ecr-dr/app-backend:latest

  only:
    - main
  when: manual
